{  
    "title": "Temperature",
        
    "properties": {
        
        "temperature": {
            "description": "Temperature value of the weather station",
            "type": "number",
            "minimum": -32.5,
            "maximum": 55.2,
            "unit": "om:degree_Celsius",
            "readOnly": true            
        },

        "threshold": {
            "description": "Temperature threshold above which an overheat event should be emitted",
            "type": "number",
            "minimum": 25,
            "maximum": 55.2,
            "unit": "om:degree_Celsius",
            "processes": {                
                "onWriteProc": {
                    "triggers": [
                        {
                            "runtimeEvent": "writeProperty",
                            "interactionAffordance": "threshold"
                        }
                    ],
                    "instructions": [
                        { 
                            "move": {
                                "from": { "pointer": ["/p/threshold/i"] },
                                "to": { "pointer": ["/dmap/threshold"] }
                            }
                        }
                    ]
                },                                
                "onReadProc": {
                    "triggers": [
                        {
                            "runtimeEvent": "readProperty",
                            "interactionAffordance": "threshold"
                        }
                    ],
                    "instructions": [
                        { 
                            "move": {
                                "from": { "pointer": ["/dmap/threshold"] },
                                "to": { "pointer": ["/p/threshold/o"] }
                            }
                        }
                    ]
                }
            }
        }
    },

    "actions": {

        "shutdown": {
            "processes": {
                "someProc": {
                    "instructions": [
                        { "control": "shutdown" }
                    ]
                }
            }
        },

        "service": {
            "input": {
                "type": "object",
                "properties": {
                    "op": { "type": "string" },
                    "path": { "type": "string" },
                    "content": { "type": "object" }
                }
            },
            "output": {
                "type": "object"
            },
            "processes": {
                "handle": {
                    "instructions": [
                        {
                            "switch": {
                                "switch": ["../i/op"],
                                "cases": [
                                    {
                                        "case": { "compound": "read" },
                                        "instructions": [
                                            {
                                                "move": {
                                                    "from": {
                                                        "compound": {
                                                            "response": "SUCCESS",
                                                            "requestedPath": { "copy": "../i/path" },
                                                            "resolvedPath": "${../i/path}",
                                                            "val": { "copy": "${../i/path}" }
                                                        }
                                                    }, 
                                                    "to": { "pointer": ["../o"] }
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        "case": { "compound": "write" },
                                        "instructions": [
                                            {
                                                "move": {
                                                    "from": { "compound": { "copy": "../i/content/val" } },
                                                    "to": { "pointer": ["${../i/path}"] }
                                                }
                                            },
                                            {
                                                "move": {
                                                    "from": {
                                                        "compound": {
                                                            "response": "SUCCESS",
                                                            "requestedPath": { "copy": "../i/path" },
                                                            "resolvedPath": "${../i/path}",
                                                            "newVal": { "copy": "${../i/path}" }
                                                        }
                                                    },
                                                    "to": { "pointer": ["../o"] }
                                                }
                                            }
                                        ]
                                    }
                                ],
                                "default": [
                                    {
                                        "move": {
                                            "from": { "compound": { "response": "Invalid op: ${../i/op}" } },
                                            "to": { "pointer": ["../o"] }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        }
    },

    "events": {

        "overheat": {
            "data": {
                "type": "object",
                "properties": {
                    "timestamp": { "type": "string" },
                    "temperature": { "type": "number" },
                    "threshold": { "type": "number" }
                }
            },
            "processes": {
                "someProc": {
                    "instructions": [
                        { "log": ["Overheat event emitted at ${dt/iso}"] }
                    ]
                }
            }
        }
    },
    
    "sensors": {

        "temperature": {
            "dataMap": {
                "val": {
                    "type": "number",
                    "minimum": -32.5,
                    "maximum": 55.2
                }
            },
            "processes": {
                "sim": {
                    "triggers": [ { "interval": { "expr": ["${/dmap/sampleInterval}"] } } ],
                    "dataMap": {
                        "debug": {
                            "type": "boolean",
                            "default": false
                        }
                    },
                    "instructions": [
                        {
                            "move": {
                                "from": { "math": { "expr": ["random(20,55)"] } },
                                "to": { "pointer": ["../dmap/val"] }
                            }
                        },
                        {
                            "move": {
                                "from": { "pointer": ["../dmap/val"] },
                                "to": { "pointer": ["/p/temperature/o"] }
                            }
                        },
                        {
                            "ifelse": {
                                "if": {
                                    "condition": { "expr": ["${./dmap/debug}"] },
                                    "instructions": [
                                        { "log": ["${/dt/iso} Current temperature: ${../dmap/val}"] }
                                    ]
                                }
                            }
                        },
                        {
                            "ifelse": {
                                "if": {
                                    "condition": { "expr": ["${../dmap/val} > ${/dmap/threshold}"] },
                                    "instructions": [
                                        {
                                            "emitEvent": {
                                                "pointer": ["/e/overheat"],
                                                "data": {
                                                    "compound": {
                                                        "timestamp": "${dt/iso}",
                                                        "temperature": { "copy": "../dmap/val" },
                                                        "threshold": { "copy": "/dmap/threshold" }
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        }                       
                    ]
                }
            }            
        }
    },

    "dataMap": {

        "threshold": {
            "type": "number",
            "minimum": -32.5,
            "maximum": 55.2
        },

        "sampleInterval": {
            "type": "number",
            "default": 1000,
            "minimum": 10
        }
    },

    "processes": {

        "initProc": {
            "triggers": [ { "runtimeEvent": "startup" } ],
            "instructions": [
                {
                    "move": {
                        "from": { "compound": 45 },
                        "to": { "pointer": ["/dmap/threshold"] }
                    }
                },
                { "log": ["Initialized threshold to: ${/dmap/threshold}"] }
            ]
        },

        "shutdownProc": {
            "triggers": [ { "runtimeEvent": "shutdown" } ],
            "instructions": [
                { "log": ["Shutting down"] }
            ]
        }
    }
}